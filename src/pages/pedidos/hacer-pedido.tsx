import {
  MakeOrderAppBar,
  MakeOrderBilling,
  MakeOrderProductSelect,
  MakeOrderStepper,
} from '@/components';
import { MakeOrderShipping } from '@/components/Orders/MakeOrder/Shipping';
import useCollection from '@/hooks/useCollection';
import { MakeOrderForm } from '@/types';
import { ProductModel } from '@/types/Products/Product';
import { orderBy } from 'firebase/firestore';
import Head from 'next/head';
import { useEffect } from 'react';
import { FormProvider, useForm, useWatch } from 'react-hook-form';

const MakeOrder = () => {
  const formMethods = useForm<MakeOrderForm>({
    defaultValues: {
      steps: { activeStep: 0, completedSteps: [] },
      products: {
        products: [],
        loading: true,
      },
      selectedProducts: [],
      billingInformation: {
        billingType: 'charge',
        documentNumber: null,
        documentType: null,
        email: '',
        lastName: '',
        name: '',
        phoneNumber: null,
        businessName: '',
        rut: null,
        rutEmail: null,
      },
      shippingInformation: {
        address: '',
        city: null,
        details: null,
        lastName: null,
        name: null,
        neighborhood: '',
        phoneNumber: null,
        date: null,
      },
    },
    mode: 'all',
  });

  const [productsSnapshot, { loading }] = useCollection<ProductModel>(
    [orderBy('sortIndex')],
    'products',
  );

  const activeStep = useWatch({
    control: formMethods.control,
    name: 'steps.activeStep',
  });

  useEffect(() => {
    formMethods.setValue(
      'products.products',
      productsSnapshot?.docs.map((productDoc) => productDoc.data()) ?? [],
    );
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [productsSnapshot]);

  useEffect(() => {
    formMethods.setValue('products.loading', loading);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [loading]);

  return (
    <>
      <Head>
        <title>Pedidos - Hacer pedido</title>
        <meta
          name="description"
          content="Generated by create next app"
        />
      </Head>
      <FormProvider {...formMethods}>
        <div style={{ width: '100%', paddingTop: 24, paddingBottom: 64 + 8 }}>
          <MakeOrderStepper />
          {activeStep === 0 && <MakeOrderProductSelect />}
          {activeStep === 1 && <MakeOrderBilling />}
          {activeStep === 2 && <MakeOrderShipping />}
        </div>
        <MakeOrderAppBar />
      </FormProvider>
    </>
  );
};

export default MakeOrder;
